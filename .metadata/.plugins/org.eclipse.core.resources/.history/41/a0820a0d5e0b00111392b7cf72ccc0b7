package com.orangeHRM.pages;

import java.time.Duration;
import java.util.List;

import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

public class AdminPage {

    WebDriver driver;
    WebDriverWait wait;

    public AdminPage(WebDriver driver) {
        this.driver = driver;
        this.wait = new WebDriverWait(driver, Duration.ofSeconds(10));
    }

    // ================= LOCATORS =================

    private By adminMenu = By.xpath("//span[normalize-space()='Admin']");
    private By addButton = By.xpath("//button[normalize-space()='Add']");
    private By usernameSearchField = By.xpath("(//input[@class='oxd-input oxd-input--active'])[2]");
    private By searchButton = By.xpath("//button[normalize-space()='Search']");
    private By resultTableRows = By.xpath("//div[@role='rowgroup']/div");
    private By deleteConfirmButton = By.xpath("//button[normalize-space()='Yes, Delete']");
    private By tableRows = By.xpath("//div[@role='rowgroup']/div");
    private By noRecordsFound = By.xpath("//span[text()='No Records Found']");


    // ================= ACTION METHODS =================

    // Click Admin menu
    public void clickAdminMenu() {
        wait.until(ExpectedConditions.visibilityOfElementLocated(adminMenu));
        wait.until(ExpectedConditions.elementToBeClickable(adminMenu)).click();
    }

    // Click Add button
    public void clickAddButton() {
        wait.until(ExpectedConditions.visibilityOfElementLocated(addButton));
        wait.until(ExpectedConditions.elementToBeClickable(addButton)).click();
    }

    // Search user by username
    public void searchUser(String username) {

        wait.until(ExpectedConditions.visibilityOfElementLocated(usernameSearchField)).clear();
        driver.findElement(usernameSearchField).sendKeys(username);

        wait.until(ExpectedConditions.elementToBeClickable(searchButton)).click();

        // Wait for results to load
        wait.until(ExpectedConditions.visibilityOfElementLocated(resultTableRows));
    }

    // Verify user present in result table
    public boolean verifyUserPresent(String username) {

        wait.until(ExpectedConditions.visibilityOfElementLocated(resultTableRows));

        List<WebElement> rows = driver.findElements(resultTableRows);

        for (WebElement row : rows) {
            if (row.getText().contains(username)) {
                return true;
            }
        }
        return false;
    }
    public void deleteUser(String username) {

        // Wait for search results
        wait.until(ExpectedConditions.visibilityOfElementLocated(tableRows));

        // Click delete icon for specific username row
        By deleteIcon = By.xpath("//div[@role='row' and .//div[text()='" + username + "']]//button//i[contains(@class,'bi-trash')]");

        wait.until(ExpectedConditions.elementToBeClickable(deleteIcon)).click();

        // Wait for confirmation popup and click Yes, Delete
        wait.until(ExpectedConditions.elementToBeClickable(deleteConfirmButton)).click();

        // Wait until popup disappears
        wait.until(ExpectedConditions.invisibilityOfElementLocated(deleteConfirmButton));
    }

}
